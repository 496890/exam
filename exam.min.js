/*!
	易时代 问卷答题系统客户端程序
	最后修订： 2023/9/30

	基于微信的网页授权（公众号需要具备网页授权能力）
	1.微信端用户确认授权
	2.PC端显示二维码，微信扫码授权

	服务端请求
	1.凭Unionid获取当前用户		/?type=user
	2.完成答题（交卷）		/?type=save
	3.获取所有用户及答题成绩		/?type=getall

	Redis
	数据Key名	exam.users
	类型		hash

	用于本地浏览器存储的Session名
	app.exam.unionid

 */
class Auth extends AuthBase{constructor(t={}){const e=t.appids,s={web:`https://open.weixin.qq.com/connect/qrconnect?appid=${e.web}&redirect_uri={url}&response_type=code&scope=snsapi_login&state={state}#wechat_redirect`,subscribe:`https://open.weixin.qq.com/connect/oauth2/authorize?appid=${e.subscribe}&redirect_uri={url}&response_type=code&scope=snsapi_userinfo&state={state}#wechat_redirect`};super(Object.assign({oauth2:s.subscribe,appid:e.web},t))}}class Unionid{constructor(t){const e=ESD.Hash();this.session="app.exam.unionid",this.host=t,this.unionid=ESD.getItem(this.session,"session")||e.unionid||"",e.unionid&&ESD.setItem(this.session,e.unionid,"session"),history.replaceState(null,null," ")}check(){return new Promise((t=>{this.unionid?fetch(`${this.host}/?type=user`,{method:"post",headers:{Authorization:this.unionid},body:JSON.stringify({key:Config.DB,field:this.unionid})}).then((t=>t.json())).then((e=>{console.log(e),(e=ESD.isJSON(e.data[0])).status?(e.unionid=this.unionid,t(e)):t({status:-1,unionid:this.unionid})})):setTimeout((()=>{t({})}),500)}))}}Vue.component("c-user",{props:["user"],template:'\n\t\t<transition name="slideRight">\n\t\t\t<div class="weui-user" title="\u60a8\u597d\uff0c" v-if="user.name">{{user.name}}</div>\n\t\t</transition>\n\t'}),Vue.component("c-ranks",{props:["title","user"],data:function(){return{json:{}}},template:'\n\t\t\t<div class="weui-form">\n\t\t\t\t<div class="weui-form__text-area">\n\t\t\t\t\t<h2 class="weui-form__title large">{{TXT.TopTitle.replace(/{@count}/, Config.Tops)}}</h2>\n\t\t\t\t\t<h2 class="weui-form__desc">{{title}}</h2>\n\t\t\t\t</div>\n\t\t\t\t<ul class="weui-ranking">\n\t\t\t\t<li class="Ranking">\u6392\u540d</li><li class="Name">{{TXT.Name}}</li><li>\u7528\u65f6</li><li class="Result">\u5f97\u5206</li>\n\t\t\t\t</ul>\n\t\t\t\t<transition name="fade">\n\t\t\t\t\t<div class="weui-form__tips-area" v-if="!Object.keys(json).length"><i class="weui-mask-loading"></i></div>\n\t\t\t\t</transition>\n\t\t\t\t<ul class="weui-ranking" v-for="(m,n) in list" :key="m">\n\t\t\t\t<li class="Ranking SN">{{n+1}}</li><li class="Name">{{m.name}}</li><li>{{m.duration}}\u79d2</li><li class="Result">{{m.score}}</li>\n\t\t\t\t</ul>\n\t\t\t\t<div class="weui-form__ft">\n\t\t\t\t\t<div class="weui-form__tips-area"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t',created(){Config.host&&fetch(`${Config.host}/?type=getall`,{method:"post",headers:{"X-Client-IP":this.user.ip,Authorization:this.user.unionid||encodeURIComponent(this.user.name)},body:JSON.stringify({key:Config.DB})}).then((t=>t.json())).then((t=>{t.error&&(weui.topTips(`\u9519\u8bef\uff1a${t.data}`),t={}),setTimeout((()=>{this.json=t||{}}),500)}))},computed:{list(){return Object.values(this.json).map((t=>ESD.isJSON(t))).sort(((t,e)=>e.score-t.score)).sort(((t,e)=>t.duration-t.duration)).slice(0,Config.Tops).map((t=>({name:t.name,duration:t.duration.roundSecond(),score:t.score})))}}}),Vue.component("c-honor",{props:["title","user"],template:'\n\t\t\t\t<div class="weui-msg">\n\t\t\t\t\t<div class="weui-msg__icon-area"><i class="weui-icon-success weui-icon_msg"></i></div>\n\t\t\t\t\t<div class="weui-msg__text-area">\n\t\t\t\t\t\t<h2 class="weui-msg__title">{{title}}</h2>\n\t\t\t\t\t\t<p class="weui-msg__desc">\u60a8\u7684\u672c\u6b21\u7b54\u9898\u5df2\u5168\u90e8\u5b8c\u6210\uff0c\u4ece\u7b2c1\u9898\u5f00\u59cb\u5230\u63d0\u4ea4\uff0c\u7528\u65f6{{user.duration.roundSecond()}}\u79d2\uff0c\u6700\u7ec8\u5f97\u5206\uff1a<span class="score">{{user.score}}</span>\u5206\uff0c\u611f\u8c22\u60a8\u7684\u53c2\u4e0e\uff0c\u7a0d\u540e\u8bf7\u5173\u6ce8\u83b7\u5956\u540d\u5355\uff01</p>\n\t\t\t\t\t\t<div class="weui-msg__custom-area">\n\t\t\t\t\t\t\t<ul class="weui-form-preview__list">\n\t\t\t\t\t\t\t\t<li class="weui-form-preview__item" v-for="m in result" :key="m"><label class="weui-form-preview__label">{{m.key}}</label><p class="weui-form-preview__value">{{m.value}}</p></li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t',computed:{result(){let{name:t,phone:e,duration:s,create_time:i}=this.user;return[{key:TXT.Name,value:t},{key:TXT.Phone,value:e},{key:"\u65e5\u671f",value:ESD.GetDate(1,i)},{key:"\u7528\u65f6",value:s.roundSecond()+"\u79d2"}]}}}),Vue.component("c-exams",{props:["title","intro","list","config","user"],data:function(){return{option:"ABCDEFGHIJK",progress:0,duration:ESD.GetDate(0)}},template:'\n\t\t\t<div class="weui-form">\n\t\t\t\t<div class="weui-form__text-area">\n\t\t\t\t\t<h2 class="weui-form__title">{{title}}</h2>\n\t\t\t\t\t<div class="weui-form__desc">{{intro}}</div>\n\t\t\t\t\t<div class="weui-msg__custom-area">\n\t\t\t\t\t\t<ul class="weui-form-preview__list">\n\t\t\t\t\t\t\t<li class="weui-form-preview__item"><label class="weui-form-preview__label">\u5f00\u59cb</label><p class="weui-form-preview__value">{{config.start}}</p></li>\n\t\t\t\t\t\t\t<li class="weui-form-preview__item"><label class="weui-form-preview__label">\u7ed3\u675f</label><p class="weui-form-preview__value">{{config.end}}</p></li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="weui-form__control-area" v-if="user.status<0">\n\t\t\t\t\t<div class="weui-form__text-area">\n\t\t\t\t\t\t<div class="weui-form__title">{{TXT.Register}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="weui-cells__group weui-cells__group_form">\n\t\t\t\t\t\t<div class="weui-cells__title">\u586b\u5199\u60a8\u7684\u8d44\u6599</div>\n\t\t\t\t\t\t<div class="weui-cells">\n\t\t\t\t\t\t\t<label class="weui-cell weui-cell_active">\n\t\t\t\t\t\t\t\t<div class="weui-cell__hd"><span class="weui-label">{{TXT.Name}}</span><div class="weui-cell__desc">{{TXT.Name_Desc}}</div></div>\n\t\t\t\t\t\t\t\t<div class="weui-cell__bd">\n\t\t\t\t\t\t\t\t\t<input type="text" class="weui-input" placeholder="\u5fc5\u586b\u9879" maxlength="9" v-model.lazy.trim="user.name" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<label class="weui-cell weui-cell_active">\n\t\t\t\t\t\t\t\t<div class="weui-cell__hd"><span class="weui-label">{{TXT.Phone}}</span><div class="weui-cell__desc">{{TXT.Phone_Desc}}</div></div>\n\t\t\t\t\t\t\t\t<div class="weui-cell__bd">\n\t\t\t\t\t\t\t\t\t<input type="number" class="weui-input" placeholder="\u5fc5\u586b\u9879" maxlength="11" v-model="user.phone" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="weui-form__control-area" v-else>\n\t\t\t\t\t<div class="weui-cells__group weui-cells__group_form" v-for="(val, key, index) in questions" :key="key">\n\t\t\t\t\t\t<div class="weui-cells__title">{{subTitle(key, index)}}</div>\n\t\t\t\t\t\t<div class="weui-cells" v-for="(m,n) in questions[key]" :key="m">\n\t\t\t\t\t\t\t<label class="weui-cell">\n\t\t\t\t\t\t\t\t<span class="wuei-cell__hd">{{ESD.FixNum(n+1,2)}}.</span>\n\t\t\t\t\t\t\t\t<span class="weui-cell__bd">\n\t\t\t\t\t\t\t\t\t<span>{{m.question}}</span>\n\t\t\t\t\t\t\t\t\t<div class="weui-cell__desc">\u8be5\u9898\u5f97\u5206\uff1a<u>{{config.type[key].point}}</u>\u5206</div>\n\t\t\t\t\t\t\t\t\t<div class="weui-cells" :class="m.type==\'multi\'?\'weui-cells_checkbox\':\'weui-cells_radio\'">\n\t\t\t\t\t\t\t\t\t\t<label class="weui-cell weui-check__label" :for="key+n+i" v-for="(item,i) in m.option" :key="item">\n\t\t\t\t\t\t\t\t\t\t\t<div class="weui-cell__hd">{{option.substr(i,1)}}.</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="weui-cell__bd">\n\t\t\t\t\t\t\t\t\t\t\t\t<p>{{item}}</p>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="weui-cell__ft">\n\t\t\t\t\t\t\t\t\t\t\t\t<input type="checkbox"\tv-if="m.type==\'multi\'"\tclass="weui-check" :name="key+n" :id="key+n+i" v-model="m.answer" :value="option.substr(i,1)" />\n\t\t\t\t\t\t\t\t\t\t\t\t<input type="radio"\t\tv-else\t\t\t\t\tclass="weui-check" :name="key+n" :id="key+n+i" v-model="m.answer" :value="option.substr(i,1)" />\n\t\t\t\t\t\t\t\t\t\t\t\t<span class="weui-icon-checked"></span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="weui-form__tips-area" v-if="user.status==-1">\n\t\t\t\t\t<p class="weui-form__tips">\u8bf7\u6b63\u786e\u586b\u5199\u8d44\u6599\u4ee5\u6fc0\u6d3b\u786e\u8ba4\u6309\u94ae</p>\n\t\t\t\t</div>\n\t\t\t\t<div class="weui-form__opr-area" v-if="[-1,0].includes(user.status)">\n\t\t\t\t\t<a class="weui-btn weui-btn_primary" :class="{\'weui-btn_disabled\':disabled}" href="javascript:" @click="submission">{{user.status==0?\'\u4ea4\u5377\':\'\u786e\u8ba4\'}}</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t',watch:{list:{handler(t){let e=this.list.filter((t=>t.answer&&t.answer.length));console.log("vue.list",this.list.length,e.length),this.progress=e.length,this.$emit("progress",e.length),1==e.length&&(this.duration=ESD.GetDate(0))},deep:!0}},computed:{disabled(){return this.user.status<0?!(this.user.name&&ESD.Phone(this.user.phone)):this.progress!=this.list.length},questions(){let t={};for(let e in this.config.type)t[e]=this.list.filter((t=>t.type==e));return t}},methods:{subTitle(t,e){const s=this.config.type[t];return`${"\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341".substr(e,1)}\u3001${s.name} \uff08\u6bcf\u9898${s.point}\u5206\uff0c\u603b\u8ba1${this.questions[t].length*s.point}\u5206\uff09`},submission(){if(!this.disabled)switch(this.user.status){case-1:this.user.status++;break;case 0:try{weui.loading("\u6b63\u5728\u63d0\u4ea4...");let t=0,e=this.list.map((e=>{if("multi"===e.type)e.answer=e.answer.sort().join("");return t+=e.answer.toLowerCase()==e.key?this.config.type[e.type].point:0,delete e.type,delete e.question,delete e.option,e}));Object.assign(this.user,{sheet:e,score:t,duration:ESD.GetDate(0)-this.duration,status:1}),Config.host?fetch(`${Config.host}/?type=save`,{method:"post",headers:{Authorization:this.user.unionid},body:JSON.stringify(this.user)}).then((t=>t.json())).then((t=>{weui.loading().hide(),t.error?weui.topTips(`\u9519\u8bef\uff1a${t.data}`):(weui.toast("\u6210\u7ee9\u5df2\u4fdd\u5b58"),this.$emit("complete",this.user))})):this.$emit("complete",this.user)}catch(t){weui.topTips(`\u9519\u8bef\uff1a${t}`)}}}}}),Number.prototype.roundSecond=function(){return Math.round(this/1e3)};const TXT={Menu:[]},Config={DB:"exam.users",SESSION:"exam.user",Review:!1,Tops:10},Icon={exams:'<svg t="1685369619895" class="icon" viewBox="0 0 1256 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2749" width="108" height="108"><path d="M201.681455 74.472727a111.709091 111.709091 0 0 0-111.709091 111.709091v651.636364a111.709091 111.709091 0 0 0 111.709091 111.709091h837.818181a111.709091 111.709091 0 0 0 111.709091-111.709091V186.181818a111.709091 111.709091 0 0 0-111.709091-111.709091h-837.818181z m0-74.472727h837.818181a186.181818 186.181818 0 0 1 186.181819 186.181818v651.636364a186.181818 186.181818 0 0 1-186.181819 186.181818h-837.818181a186.181818 186.181818 0 0 1-186.181819-186.181818V186.181818a186.181818 186.181818 0 0 1 186.181819-186.181818zM302.08 719.592727a24.669091 24.669091 0 0 1-10.333091-3.258182c-19.456-8.005818-40.587636-9.076364-43.240727-33.652363-2.513455-23.738182 12.474182-78.336 23.086545-101.003637A1441.512727 1441.512727 0 0 1 345.832727 446.603636l-1.117091-0.837818-43.892363 21.876364c-1.861818 1.210182-10.519273 5.864727-12.474182 6.144-5.306182 0.558545-5.12-7.540364-5.026909-10.426182-0.558545-13.730909 8.564364-19.083636 19.456-26.903273 14.801455-10.705455 65.861818-48.174545 79.266909-49.524363 12.567273-1.256727 24.901818 23.179636 25.739636 30.301091 1.536 13.730909 1.396364 12.381091-60.416 146.52509-13.824 29.649455-45.986909 100.445091-42.496 132.142546 0.558545 5.771636 2.513455 10.845091 3.211637 16.477091 0.418909 4.235636-1.675636 6.842182-6.050909 7.261091z m416.674909-279.458909c9.914182 90.763636-60.276364 223.464727-175.336727 243.665455-44.032 7.912727-74.658909-32.256-79.127273-72.471273-5.911273-53.341091 22.341818-115.665455 53.666909-158.161455 37.329455-50.362182 106.961455-95.092364 138.286546-98.39709 19.735273-2.048 45.893818 18.152727 47.010909 28.532363 0.558545 5.213091-10.938182 6.469818-13.963637 10.146909 22.341818 4.421818 27.368727 27.741091 29.463273 46.685091z m-85.178182 121.018182c18.618182-25.413818 53.434182-86.062545 50.082909-117.294545-1.117091-9.914182-7.959273-27.322182-21.410909-25.972364-12.567273 1.396364-23.179636 20.154182-27.927272 20.712727-3.909818 0.418909-5.492364-5.073455-5.771637-7.912727-81.361455 56.878545-112.128 128.093091-109.614545 177.105454 0.465455 9.029818 5.445818 36.212364 18.897454 34.816 14.429091-1.489455 43.333818-22.760727 53.248-33.88509l42.542546-47.616z m357.282909-149.876364c10.053818 90.856727-60.136727 223.511273-175.336727 243.712-44.032 7.912727-74.658909-32.256-79.127273-72.471272-5.911273-53.341091 22.341818-115.665455 53.666909-158.161455 37.329455-50.362182 106.961455-95.092364 138.286546-98.397091 19.735273-2.048 45.893818 18.152727 47.010909 28.532364 0.558545 5.213091-10.938182 6.469818-13.963636 10.146909 22.341818 4.421818 27.368727 27.741091 29.463272 46.685091z m-85.178181 121.018182c18.757818-25.506909 53.434182-86.016 50.082909-117.294545-1.117091-9.867636-7.959273-27.275636-21.410909-25.925818-12.567273 1.396364-23.179636 20.154182-27.927273 20.712727-3.770182 0.418909-5.445818-5.073455-5.771637-7.912727-81.361455 56.878545-112.128 128.093091-109.614545 177.105454 0.465455 9.029818 5.445818 36.212364 18.897455 34.816 14.429091-1.489455 43.333818-22.760727 53.248-33.885091l42.542545-47.616z m-79.546182 171.287273s70.888727-5.957818 110.498909-7.447273c0 0-333.917091 26.205091-623.522909 127.069091 0 0-42.216727 18.897455-49.477818 15.592727-14.429091-6.423273 0-15.639273 0-15.639272-4.468364 2.094545 252.090182-105.192727 616.634181-127.069091 0 0-35.095273 4.421818-54.132363 7.447272z m110.498909 20.945454s-35.095273 4.514909-53.992727 7.447273c0 0 70.749091-5.911273 110.312727-7.447273-322.141091 25.227636-323.397818 22.481455-623.476364 127.069091 0 0-42.216727 18.897455-49.524363 15.639273-14.429091-6.469818 0-15.639273 0-15.639273s216.203636-103.191273 616.680727-127.069091zM248.226909 186.181818a23.272727 23.272727 0 1 1 0-46.545454h526.941091a23.272727 23.272727 0 0 1 0 46.545454H248.273455z m0 93.090909a23.272727 23.272727 0 1 1 0-46.545454h263.447273a23.272727 23.272727 0 1 1 0 46.545454h-263.447273z" fill="#ea9518" p-id="2750"></path></svg>',honor:'<svg t="1685370050656" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15849" width="108" height="108"><path d="M845.444741 620.923259a10428.871111 10428.871111 0 0 1 120.907852 301.24563c-8.533333 8.040296-10.619259 12.705185-14.829037 14.336a8.116148 8.116148 0 0 1-6.181926-0.18963l-190.084741-84.954074-84.15763 151.324445a18.962963 18.962963 0 0 1-34.512592-3.109926l-76.079408-223.990519c122.121481 7.661037 217.050074-43.880296 284.937482-154.661926z m-666.510222-2.427259c65.991111 112.791704 160.843852 165.129481 284.558222 157.089185l-76.079408 223.990519a18.962963 18.962963 0 0 1-34.512592 3.109926l-84.195556-151.324445-189.743407 84.840296a8.571259 8.571259 0 0 1-6.523259 0.18963c-4.437333-1.668741-6.674963-6.599111-14.71526-14.715259 33.147259-87.87437 73.53837-188.946963 121.21126-303.179852zM504.604444 0c195.584 0 354.190222 160.919704 354.190223 359.386074 0 198.504296-158.606222 359.386074-354.228148 359.386074-195.584 0-354.152296-160.881778-354.152297-359.386074C150.414222 160.919704 308.982519 0 504.604444 0z m-15.284148 145.635556l-1.782518 2.920296-54.158222 111.350518-121.704297 17.938963a18.962963 18.962963 0 0 0-12.781037 29.658074l2.23763 2.616889 88.215704 87.22963-20.745482 122.88a18.962963 18.962963 0 0 0 24.462222 21.238518l3.147852-1.327407 108.392296-57.799111 108.392297 57.799111a18.962963 18.962963 0 0 0 27.875555-16.459852l-0.265481-3.413333-20.783408-122.88 88.25363-87.267556a18.962963 18.962963 0 0 0-7.243852-31.478518l-3.337481-0.758519-121.666371-17.976889-54.196148-111.350518a18.962963 18.962963 0 0 0-32.312889-2.920296z" fill="#d81e06" p-id="15850"></path></svg>',ranks:'<svg t="1685370291984" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17385" width="108" height="108"><path d="M685 472.2v-328c0-6.6-5.4-12-12-12H352.1c-6.6 0-12 5.4-12 12v189.6c0 3.3-2.7 6-6 6H76.2c-6.6 0-12 5.4-12 12v596.5c0 6.6 5.4 12 12 12H949c6.6 0 12-5.4 12-12V490.2c0-6.6-5.4-12-12-12H691c-3.3 0-6-2.7-6-6z m-556.8 418V409.8c0-3.3 2.7-6 6-6h199.9c3.3 0 6 2.7 6 6v480.5c0 3.3-2.7 6-6 6H134.2c-3.3-0.1-6-2.8-6-6.1z m282.4 6c-3.3 0-6-2.7-6-6V339.8h-0.5V202.1c0-3.3 2.7-6 6-6H615c3.3 0 6 2.7 6 6v688.1c0 3.3-2.7 6-6 6H410.6z m480.4 0H691c-3.3 0-6-2.7-6-6v-342c0-3.3 2.7-6 6-6h200c3.3 0 6 2.7 6 6v342.1c0 3.2-2.7 5.9-6 5.9z" p-id="17386" fill="#1296db"></path><path d="M472.9 259.8v37.7l32.8-28.5v115.8H541V231.3h-35.3zM264.4 521c12.3-12.9 19-21.6 19-37.7 0-28.9-20.7-46.3-49.1-46.3-26.7 0-49.6 16.6-49.6 46.8H220c0-11.9 7.8-14.9 14.2-14.9 9.1 0 13.8 5.8 13.8 14.2 0 6.5-2.2 10.3-7.8 16.4l-55.6 60.3v31.9h98.7v-31.9h-55.6l36.7-38.8zM791.8 607.8c7.3 0 14 5 14 14.7 0 6.9-4.1 14.4-14.7 14.4h-5v30.6h5c9.5 0 16.4 6.9 16.4 16.2 0 11-6.5 16.4-15.7 16.4-8.8 0-15.7-5.4-15.7-16.2h-35.3c0 34.5 25.6 48.1 51.1 48.1 26.9 0 51.1-15.1 51.1-47.2 0-18.3-9.3-27.6-17.7-33.4 7.8-5 15.9-13.1 15.9-30 0-26.5-20.9-45.5-49.4-45.5-27.4 0-49.4 17.5-49.4 46.3h35.3c0.1-9.2 6.7-14.4 14.1-14.4z" p-id="17387" fill="#1296db"></path></svg>'},vue=new Vue({el:".weui-exam",template:'\n\t<div class="weui-tab">\n\t\t<template>\n\t\t<div class="weui-tab__panel">\n\t\t\t<c-ranks\tv-if="page==\'ranks\'"\t:title="title"\t:user="user"\t/>\n\t\t\t<c-honor\tv-if="page==\'honor\'"\t:title="title"\t:user="user"\t/>\n\t\t\t<c-exams\tv-if="page==\'exams\'"\t:title="title"\t:user="user"\t:list="list" :config="config" :intro="intro" @progress="transfer_progress" @complete="transfer_complete" />\n\t\t\t<c-user\t\t:user="user"\t/>\n\t\t</div>\n\t\t<div class="weui-tabbar">\n\t\t\t<div class="weui-tabbar__item" :class="{\'weui-bar__item_on\':m.id==page}" v-for="m in menus" :key="m" @click="page=m.id">\n\t\t\t\t<div class="weui-icon">\n\t\t\t\t\t<span v-html="Icon[m.id]"></span>\n\t\t\t\t\t<span class="weui-badge" v-if="m.badge" :count="m.badge.count" :total="m.badge.total">/</span>\n\t\t\t\t</div>\n\t\t\t\t<p class="weui-tabbar__label">{{m.name}}</p>\n\t\t\t</div>\n\t\t</div>\n\t\t</template>\n\t</div>\n',data:{title:"",intro:"",config:{type:{},menu:[]},progress:0,page:"exams",user:{},list:[]},created(){weui.loading("\u6b63\u5728\u52a0\u8f7d..."),fetch(`json/exam.config.json?${ESD.GetDate(0)}`).then((t=>t.json())).then((t=>{t.list=t.list.map((t=>{switch(t.type){case"bool":t.option=["\u6b63\u786e","\u9519\u8bef"];break;case"multi":t.answer=[]}return t})),Object.assign(this,t),Object.assign(Config,t.config.setup),Object.assign(TXT,t.config.text),this.config.menu=TXT.Menu.slice(0,Config.host?3:2),ESD.$("title").element.text=t.title;let{start:e,end:s,appid:i}=t.config,n=t=>`${ESD.GetDate(6,t)} ${ESD.GetDate(3,t).split(":").slice(0,2).join(":")}`,a=null;if(ESD.GetDate(0,s)<ESD.GetDate(0)&&(a={content:TXT.OVER,title:n(s),text:"\u7ed3\u675f"}),ESD.GetDate(0,e)>ESD.GetDate(0)&&(a={content:TXT.PENDING,title:n(e),text:"\u5f00\u59cb"}),a)weui.dialog({title:t.title,className:"weui-dialog__warning",content:`${a.content}\t<i class="date" title="${a.title}">${a.text}\u65f6\u95f4\uff1a</i>`,buttons:[]}),weui.loading().hide();else if(Config.host)new Unionid(Config.host).check().then((t=>{switch(weui.loading().hide(),t.status){case 1:this.page="honor";case 0:case-1:this.user=t;break;default:new Auth({host:Config.host,href:Config.qrcode,webapp:Config.webapp,appids:i,redirect:"exam"})}console.log("check user",t)}));else{(()=>new Promise((t=>{let e=ESD.getItem(Config.SESSION);e=ESD.isJSON(e)||{status:-1,unionid:ESD.RandomStr(28)},setTimeout((()=>{t(e)}),1e3)})))().then((t=>{weui.loading().hide(),this.user=t}))}}))},watch:{page(t,e){1!=this.user.status?(this.page="exams",weui.topTips(TXT.Deny)):"exams"!=t||Config.Review||(this.page=e,weui.topTips(TXT.Done))}},computed:{menus(){return this.config.menu.map(((t,e)=>({id:["exams","honor","ranks"][e],name:t,badge:0!=this.user.status||e?null:{count:this.progress,total:this.list.length}})))}},methods:{transfer_progress(t){this.progress=t},transfer_complete(t){this.page="honor",this.user=t,ESD.setItem(Config.SESSION,JSON.stringify(t),"session")}}});
